.if switch1 !== null
  bSwitch = switch1.@enabled
  end bSwitch == false
.fi

iEnabledPrev = iEnabled

nDistanceMax = -1

iBlock = 0
.do
  dBlock = %iBlock

  .do
    mBlockType = dBlock.@type
    .break mBlockType == @switch
    .break mBlockType == @door
    .break mBlockType == @door-large

    radar enemy any any distance dBlock 1 uEnemy
    .break uEnemy === null

    xBlock = dBlock.@x
    yBlock = dBlock.@y
    xEnemy = uEnemy.@x
    yEnemy = uEnemy.@y
    dx = xEnemy - xBlock
    dy = yEnemy - yBlock
    nDistance = dx ** 2
    dy2 = dy ** 2
    nDistance += dy2
    .if nDistance > nDistanceMax
      nDistanceMax = nDistance
      iEnabled = iBlock
    .fi
  .until

  iBlock += 1
.when iBlock < @links

.while
  iEnabled += 1
  iEnabled %= @links
  dEnabledBlock = %iEnabled
  mEnabledBlockType = dEnabledBlock.@type
  .break mEnabledBlockType == @door
  .break mEnabledBlockType == @door-large
.done

end iEnabledPrev == iEnabled

tEnd = @tick + 80
.do
.when @tick < tEnd

iBlock = 0
.do
  dBlock = %iBlock
  mBlockType = dBlock.@type
  .do
    .break mBlockType == @door
    .break mBlockType == @door-large
    jump controlNext
  .until
  bEnabled = iBlock == iEnabled
  control enabled dBlock bEnabled
controlNext:
  iBlock += 1
.when iBlock < @links
